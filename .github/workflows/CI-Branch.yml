name: CI
# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
    push:
      branches: [ dev, stage ]
    pull_request:
      branches: [ dev, stage ]
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
    build-model:
        name: Branch Specific Logic
        runs-on: ubuntu-latest        
        env:
          ACTION_SERVER: http://bot.jovensalud.net/actions/ 
          AWS_MODEL_DIRECTORY: 'Models'
          BOT_MODEL_DIRECTORY: './models'
          RUN_TRAINING: 'false'
          BRANCH_NAME: ${GITHUB_REF##*/}
        steps:
            # - uses: actions/checkout@v2   

            # - name: Set up Python 3.7
            #   uses: actions/setup-python@v1
            #   with:
            #     python-version: 3.7
        
            # - name: Install dependencies, set env
            #   run: |
            #     python -m pip install --upgrade pip
            #     pip install -r requirements.txt                
                      
            # - name: Rasa Data Validation
            #   working-directory: ${{ github.workspace }}
            #   run: |
            #     rasa data validate --debug 
            - name: ENV and Other
              run: |
                echo BRANCH_NAME : $BRANCH_NAME
                echo BRANCH_NAME : ${GITHUB_REF##*/}
                echo ACTION_SERVER : $ACTION_SERVER
                echo RUN_TRAINING : $RUN_TRAINING
                echo files : "${{steps.files.outputs.all}}"
            - name: set_training
              if: |
                  contains(  steps.files.outputs.all, 'data/' ) 
                  || contains(  steps.files.outputs.all, 'config.yml' ) 
                  || contains(  steps.files.outputs.all, 'domain.yml' )
              run: |
                echo "RUN_TRAINING=true"  >> $GITHUB_ENV
                echo "training should run"

            - name: Train model
              if: env.RUN_TRAINING == 'true'
              run: |
                # rasa train
                echo "simulate model training"
            
            
            - name: Download model from S3 
              if: env.RUN_TRAINING == 'false'
              run: |
                echo "simulate model download from S3"
            
            #   uses: jakejarvis/s3-sync-action@v0.5.1
            #   env:
            #     SOURCE_DIR: './models'
            #     AWS_REGION: 'us-east-1'
            #     AWS_S3_BUCKET: 'jovensaludbot'
            #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            #     DEST_DIR: 'Models'
                
            - name: Run Through Test Stories
              run: |
                # rasa test 
                echo "simulate model test"
            
            - name: Upload model to S3 
              if: env.RUN_TRAINING == 'true'
              run: |
                echo "simulate model upload to S3"
            #   uses: jakejarvis/s3-sync-action@v0.5.1
            #   env:
            #     SOURCE_DIR: './models'
            #     AWS_REGION: 'us-east-1'
            #     AWS_S3_BUCKET: 'jovensaludbot'
            #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            #     DEST_DIR: 'Models'
            
            
            - name: Upload model to rasa - x     
              if: env.RUN_TRAINING == 'true'  && env.BRANCH_NAME == 'stage' 
              working-directory: ${{ github.workspace }}
              run: |
                echo "simulate model upload to rasa-x"

  
